generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ================================
// USUARIOS Y AUTENTICACIÓN
// ================================

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  email     String?  @unique
  password  String
  role      String   @default("OPERATOR")  // ADMIN | MANAGER | OPERATOR
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  permissions UserPermission[]
  events      Event[]          @relation("EventCreator")

  @@map("users")
}

model UserPermission {
  id         String  @id @default(cuid())
  userId     String
  module     String  // MUSICADJ | KARAOKEYA
  canView    Boolean @default(true)
  canOperate Boolean @default(false)
  canExport  Boolean @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, module])
  @@map("user_permissions")
}

// ================================
// VENUES Y CLIENTS (REUTILIZABLES)
// ================================

model Venue {
  id           String   @id @default(cuid())
  name         String
  type         String   @default("OTHER")  // SALON | BAR | RESTAURANT | CLUB | OUTDOOR | OTHER
  address      String?
  city         String?
  capacity     Int?
  contactName  String?
  contactPhone String?
  instagramUrl String?
  notes        String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  events Event[]

  @@map("venues")
}

model Client {
  id        String   @id @default(cuid())
  name      String
  company   String?
  phone     String?
  email     String?
  cuit      String?
  notes     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events Event[]

  @@map("clients")
}

// ================================
// INVITADOS (ACCESO SIMPLIFICADO)
// ================================

// Guest = usuario final que accede via QR (sin password)
// Identificación por email, cross-evento
model Guest {
  id          String   @id @default(cuid())
  email       String   @unique
  displayName String   // "Juancho", "La Voz de Oro", etc.
  whatsapp    String?  // Opcional, para notificaciones de turno
  createdAt   DateTime @default(now())
  lastSeenAt  DateTime @updatedAt

  songRequests    SongRequest[]
  karaokeRequests KaraokeRequest[]

  @@map("guests")
}

// ================================
// EVENTOS
// ================================

model Event {
  id           String   @id @default(cuid())
  slug         String   @unique  // URL amigable: "martina-15-2501"
  status       String   @default("DRAFT")  // DRAFT | ACTIVE | PAUSED | FINISHED
  venueId      String?
  clientId     String?
  clonedFromId String?
  createdById  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  venue      Venue?  @relation(fields: [venueId], references: [id])
  client     Client? @relation(fields: [clientId], references: [id])
  clonedFrom Event?  @relation("EventClones", fields: [clonedFromId], references: [id])
  clones     Event[] @relation("EventClones")
  createdBy  User    @relation("EventCreator", fields: [createdById], references: [id])

  eventData       EventData?
  musicadjConfig  MusicadjConfig?
  songRequests    SongRequest[]
  karaokeyaConfig KaraokeyaConfig?
  karaokeRequests KaraokeRequest[]

  @@map("events")
}

model EventData {
  id              String    @id @default(cuid())
  eventId         String    @unique
  eventName       String
  eventType       String    @default("OTHER")  // WEDDING | FIFTEEN | CORPORATE | BIRTHDAY | PARTY | OTHER
  startDate       DateTime
  endDate         DateTime?
  guestCount      Int?
  instagramUrl    String?
  instagramUser   String?
  hashtag         String?
  spotifyPlaylist String?
  notes           String?
  customFields    String?   // JSON para campos adicionales

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_data")
}

// ================================
// MÓDULO MUSICADJ
// ================================

model MusicadjConfig {
  eventId             String  @id
  enabled             Boolean @default(true)
  cooldownSeconds     Int     @default(300)
  allowWithoutSpotify Boolean @default(true)
  welcomeMessage      String?
  showQueueToClient   Boolean @default(false)

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("musicadj_configs")
}

model SongRequest {
  id          String   @id @default(cuid())
  eventId     String
  guestId     String   // FK al Guest (identificación unificada)
  spotifyId   String?
  title       String
  artist      String
  albumArtUrl String?
  status      String   @default("PENDING")  // PENDING | HIGHLIGHTED | URGENT | PLAYED | DISCARDED
  priority    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  guest Guest @relation(fields: [guestId], references: [id])

  @@index([eventId, status])
  @@index([eventId, createdAt])
  @@index([guestId])
  @@map("song_requests")
}

// ================================
// MÓDULO KARAOKEYA
// ================================

// Catálogo maestro de canciones (global, no por evento)
model KaraokeSong {
  id              String   @id @default(cuid())
  title           String
  artist          String
  youtubeUrl      String?  // Link a video con LETRA/LYRICS
  language        String   @default("ES")  // ES | EN | PT
  difficulty      Int      @default(3)     // 1-5 (⭐ a ⭐⭐⭐⭐⭐)
  moods           String   @default("[]")  // JSON array: ["PARA_ROMPERLA", "ROMANTICO", etc.]
  tags            String   @default("[]")  // JSON array: ["Popular", "Clásico", "Dúo"]
  timesRequested  Int      @default(0)     // Contador global (aprendizaje cross-evento)
  timesCompleted  Int      @default(0)     // Veces cantada exitosamente
  isActive        Boolean  @default(true)  // Para ocultar sin eliminar
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  requests KaraokeRequest[]

  @@index([language])
  @@index([difficulty])
  @@map("karaoke_songs")
}

model KaraokeyaConfig {
  eventId             String  @id
  enabled             Boolean @default(true)
  cooldownSeconds     Int     @default(600)
  maxPerPerson        Int     @default(0)  // 0 = sin límite
  showQueueToClient   Boolean @default(true)
  showNextSinger      Boolean @default(true)
  // Configuración de sugerencias
  suggestionsEnabled  Boolean @default(true)
  suggestionsCount    Int     @default(3)  // 0-5, cantidad de sugerencias a mostrar
  allowedLanguages    String  @default("[]")  // JSON array: ["ES", "EN"] o vacío = todos

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("karaokeya_configs")
}

model KaraokeRequest {
  id            String    @id @default(cuid())
  eventId       String
  guestId       String    // FK al Guest (identificación unificada)
  songId        String?   // FK opcional al catálogo (null si búsqueda manual)
  title         String
  artist        String?
  turnNumber    Int
  queuePosition Int
  status        String    @default("QUEUED")  // QUEUED | CALLED | ON_STAGE | COMPLETED | NO_SHOW | CANCELLED
  createdAt     DateTime  @default(now())
  calledAt      DateTime?

  event Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  guest Guest        @relation(fields: [guestId], references: [id])
  song  KaraokeSong? @relation(fields: [songId], references: [id])

  @@index([eventId, status])
  @@index([eventId, queuePosition])
  @@index([guestId])
  @@index([songId])
  @@map("karaoke_requests")
}
